import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, 
  Trash2, 
  Euro, 
  ChefHat, 
  Loader2,
  Image as ImageIcon,
  Sparkles,
  FileDown,
  AlertTriangle,
  TrendingUp,
  Building2,
  Camera,
  FileText,
  Info
} from 'lucide-react';

/**
 * CONFIGURACIÓ GLOBAL
 * Per a GitHub: Es recomana moure aquestes constants a un fitxer .env
 */
const BROWSERLESS_TOKEN = "2U2jT273ops3ToO5db4b42b38e67c0a58d2bb01af71629e74";
const apiKey = ""; // La clau s'injecta automàticament al runtime de l'entorn

const App = () => {
  const [ingredients, setIngredients] = useState([
    { id: 1, nom: '', quantitat: 0, unitat: 'kg', preuUnitari: 0, preuMajorista: 0, fontOficial: '', dataOficial: '', merma: 0 }
  ]);
  const [nomPlat, setNomPlat] = useState('');
  const [buscantDades, setBuscantDades] = useState(false);
  const [analitzantRecepta, setAnalitzantRecepta] = useState(false);
  const [generantImatge, setGenerantImatge] = useState(false);
  const [imatgePlat, setImatgePlat] = useState(null);
  const [margenBenefici, setMargenBenefici] = useState(70);
  const [error, setError] = useState(null);
  
  const fileInputRef = useRef(null);

  // Lògica de càlcul de costos considerant la merma
  const calcularCostReal = (ing) => {
    const rendiment = 1 - (ing.merma / 100);
    const quantitatBruta = ing.quantitat / (rendiment || 1);
    return quantitatBruta * (ing.preuUnitari || 0);
  };

  const costTotalIngredients = ingredients.reduce((acc, curr) => acc + calcularCostReal(curr), 0);
  const preuSugerit = costTotalIngredients / (1 - (margenBenefici / 100));

  // Funció per detectar desviacions significatives de preu
  const teDiscrepancia = (ing) => {
    if (!ing.preuUnitari || !ing.preuMajorista) return false;
    const diferencia = ((ing.preuUnitari - ing.preuMajorista) / ing.preuMajorista) * 100;
    return diferencia > 20;
  };

  // Scraping de preus en viu mitjançant Browserless
  const buscarPreusEnViu = async (producte) => {
    const puppeteerScript = {
      code: `module.exports = async ({ page, context }) => {
        try {
          await page.goto('https://www.mercasa.es/precios-y-mercados-mayoristas/', { 
            waitUntil: 'networkidle0',
            timeout: 30000 
          });
          await page.waitForSelector('table', { timeout: 5000 }).catch(() => null);
          const dades = await page.evaluate(() => {
            const rows = Array.from(document.querySelectorAll('tr'));
            return rows
              .filter(r => r.innerText.includes('€') || r.innerText.includes(','))
              .map(r => r.innerText.replace(/\\n/g, ' '))
              .join(' | ')
              .substring(0, 3000);
          });
          return { data: dades || "Sense dades" };
        } catch (e) {
          return { data: "Error: " + e.message };
        }
      };`
    };

    try {
      const response = await fetch(`https://chrome.browserless.io/execute?token=${BROWSERLESS_TOKEN}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(puppeteerScript)
      });
      return await response.json();
    } catch (e) {
      return { data: "Error de connexió" };
    }
  };

  // Protocol de cerca professional amb IA
  const executarProtocolCercaProfessional = async () => {
    const validIngs = ingredients.filter(i => i.nom.trim() !== '');
    if (!validIngs.length) return;
    setBuscantDades(true);
    setError(null);
    try {
      const nousIngredients = await Promise.all(ingredients.map(async (ing) => {
        if (!ing.nom) return ing;
        const resultatScraping = await buscarPreusEnViu(ing.nom);
        const prompt = `Analitza aquestes dades de Mercasa: "${resultatScraping.data}". Troba el preu per kg/unitat per a "${ing.nom}". Si no el trobes, estima un preu realista. Retorna JSON: {"preu": 0.00, "unitat": "kg", "font": "Mercasa Live"}`;

        const interpretacio = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json" }
          })
        });
        const dataGemini = await interpretacio.json();
        const jsonRes = JSON.parse(dataGemini.candidates[0].content.parts[0].text);
        return {
          ...ing,
          preuUnitari: jsonRes.preu || ing.preuUnitari,
          preuMajorista: (jsonRes.preu * 0.9) || (ing.preuUnitari * 0.9),
          fontOficial: jsonRes.font || 'Estimació IA',
          dataOficial: new Date().toLocaleDateString(),
          unitat: jsonRes.unitat || ing.unitat
        };
      }));
      setIngredients(nousIngredients);
    } catch (err) {
      setError("Error en la sincronització de preus.");
    } finally {
      setBuscantDades(false);
    }
  };

  // Generació d'imatge culinària amb Imagen
  const generarFotoPlat = async () => {
    if (!nomPlat) return;
    setGenerantImatge(true);
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          instances: { prompt: `Elegant gourmet culinary presentation of ${nomPlat}, minimalist luxury restaurant setting, cinematic lighting, macro photography, 8k resolution.` },
          parameters: { sampleCount: 1 }
        })
      });
      const result = await response.json();
      if (result.predictions?.[0]?.bytesBase64Encoded) {
        setImatgePlat(`data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setGenerantImatge(false);
    }
  };

  // Processament de fitxers de receptes (Multimodal)
  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setAnalitzantRecepta(true);
    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64Data = reader.result.split(',')[1];
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: "Extract recipe info into JSON: { \"nomPlat\": \"\", \"ingredients\": [{ \"nom\": \"\", \"quantitat\": 0, \"unitat\": \"kg\", \"merma\": 0 }] }" },
                { inlineData: { mimeType: file.type, data: base64Data } }
              ]
            }],
            generationConfig: { responseMimeType: "application/json" }
          })
        });
        const data = await response.json();
        const parsed = JSON.parse(data.candidates[0].content.parts[0].text);
        setNomPlat(parsed.nomPlat);
        setIngredients(parsed.ingredients.map(i => ({ ...i, id: Math.random(), preuUnitari: 0, preuMajorista: 0 })));
      } catch (err) {
        setError("Error processant la recepta.");
      } finally {
        setAnalitzantRecepta(false);
      }
    };
    reader.readAsDataURL(file);
  };

  return (
    <div className="min-h-screen bg-[#F8FAFC] text-slate-900 font-sans pb-20 p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
          <div className="flex items-center gap-5">
            <div className="w-14 h-14 bg-slate-900 rounded-xl flex items-center justify-center shadow-lg">
              <ChefHat className="text-orange-500 w-7 h-7" />
            </div>
            <div>
              <h1 className="text-3xl font-black tracking-tight text-slate-900">FoodCost Studio</h1>
              <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Gestió Intel·ligent per a Cuines Professionals</p>
            </div>
          </div>
          
          <div className="flex gap-3">
            <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
            <button onClick={() => fileInputRef.current.click()} className="bg-white border border-slate-200 px-5 py-3 rounded-xl font-bold text-xs flex items-center gap-2 hover:bg-slate-50 transition-all">
              {analitzantRecepta ? <Loader2 className="animate-spin text-orange-500" size={16} /> : <FileText className="text-orange-500" size={16} />} 
              Importar
            </button>
            <button onClick={() => window.print()} className="bg-slate-900 text-white px-5 py-3 rounded-xl font-bold text-xs flex items-center gap-2 hover:bg-slate-800 transition-all shadow-md">
              <FileDown size={16} /> Exportar
            </button>
          </div>
        </header>

        {error && (
          <div className="mb-6 p-4 bg-red-50 text-red-600 rounded-xl border border-red-100 flex items-center gap-2 text-sm">
            <AlertTriangle size={16} /> {error}
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          <div className="lg:col-span-8 space-y-8">
            <section className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-8">
              <div className="flex-1">
                <div className="inline-flex items-center gap-2 px-3 py-1 bg-orange-50 text-orange-600 rounded-full mb-4">
                  <Sparkles size={12} />
                  <span className="text-[9px] font-black uppercase tracking-widest">Master Recipe</span>
                </div>
                <input 
                  className="text-4xl font-black w-full border-none focus:ring-0 placeholder-slate-200" 
                  placeholder="Nom del plat..." 
                  value={nomPlat} 
                  onChange={e => setNomPlat(e.target.value)} 
                />
                <button 
                  onClick={generarFotoPlat} 
                  disabled={generantImatge || !nomPlat} 
                  className="mt-6 flex items-center gap-2 text-[10px] font-black text-slate-400 hover:text-orange-500 uppercase tracking-widest transition-colors"
                >
                  {generantImatge ? <Loader2 className="animate-spin" size={14} /> : <Camera size={14} />} 
                  Generar Imatge IA
                </button>
              </div>
              <div className="w-full md:w-64 h-64 bg-slate-50 rounded-2xl overflow-hidden border border-slate-100 relative">
                {imatgePlat ? (
                  <img src={imatgePlat} className="w-full h-full object-cover" alt="Plat" />
                ) : (
                  <div className="w-full h-full flex flex-col items-center justify-center text-slate-200 italic text-[10px] font-bold">
                    <ImageIcon size={40} className="mb-2" strokeWidth={1} /> Visualització
                  </div>
                )}
                {generantImatge && (
                  <div className="absolute inset-0 bg-white/60 backdrop-blur-sm flex items-center justify-center">
                    <Loader2 className="animate-spin text-orange-500" />
                  </div>
                )}
              </div>
            </section>

            <section className="bg-white rounded-3xl shadow-sm border border-slate-100 p-8">
              <div className="flex justify-between items-center mb-8">
                <h2 className="text-xl font-black">Escandall de Costos</h2>
                <button 
                  onClick={executarProtocolCercaProfessional} 
                  disabled={buscantDades} 
                  className="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white transition-all disabled:opacity-50"
                >
                  {buscantDades ? <Loader2 className="animate-spin" size={14} /> : <TrendingUp size={14} />} 
                  Sincronitzar Preus
                </button>
              </div>

              <div className="space-y-4">
                {ingredients.map(ing => (
                  <div key={ing.id} className={`p-5 rounded-2xl border transition-all grid grid-cols-1 md:grid-cols-12 gap-4 items-center group ${teDiscrepancia(ing) ? 'border-red-100 bg-red-50/20' : 'border-slate-50 bg-slate-50/30'}`}>
                    <div className="md:col-span-5">
                      <input 
                        className="w-full bg-transparent border-none p-0 font-bold text-slate-800 placeholder-slate-300 focus:ring-0" 
                        value={ing.nom} 
                        placeholder="Ingredient..." 
                        onChange={e => setIngredients(ingredients.map(i => i.id === ing.id ? {...i, nom: e.target.value} : i))} 
                      />
                      {ing.fontOficial && <span className="text-[8px] font-black text-blue-400 uppercase tracking-tighter block mt-1">{ing.fontOficial}</span>}
                    </div>
                    <div className="md:col-span-2 flex items-center bg-white rounded-lg px-2 border border-slate-100 shadow-sm">
                      <input type="number" className="w-full border-none p-1 text-xs font-bold focus:ring-0" value={ing.quantitat} onChange={e => setIngredients(ingredients.map(i => i.id === ing.id ? {...i, quantitat: parseFloat(e.target.value)} : i))} />
                      <span className="text-[9px] font-black text-slate-300 uppercase">{ing.unitat}</span>
                    </div>
                    <div className="md:col-span-2">
                      <input type="number" className="w-full border-none bg-transparent p-1 text-xs font-bold text-center focus:ring-0" value={ing.merma} placeholder="Merma %" onChange={e => setIngredients(ingredients.map(i => i.id === ing.id ? {...i, merma: parseFloat(e.target.value)} : i))} />
                    </div>
                    <div className="md:col-span-2 text-right">
                      <span className="text-xs font-black text-slate-900">{calcularCostReal(ing).toFixed(2)}€</span>
                    </div>
                    <div className="md:col-span-1 flex justify-end">
                      <button onClick={() => setIngredients(ingredients.filter(x => x.id !== ing.id))} className="text-slate-200 hover:text-red-500 transition-colors">
                        <Trash2 size={16} />
                      </button>
                    </div>
                  </div>
                ))}
                <button onClick={() => setIngredients([...ingredients, { id: Math.random(), nom: '', quantitat: 0, unitat: 'kg', preuUnitari: 0, merma: 0 }])} className="w-full py-4 border-2 border-dashed border-slate-100 rounded-2xl text-[10px] font-black uppercase text-slate-400 hover:border-orange-200 hover:bg-orange-50 transition-all">
                  + Afegir Ingredient
                </button>
              </div>
            </section>
          </div>

          <div className="lg:col-span-4 space-y-6">
            <div className="bg-slate-900 text-white p-8 rounded-[2.5rem] shadow-xl relative overflow-hidden">
              <div className="relative z-10">
                <h3 className="text-xs font-black text-orange-500 uppercase tracking-widest mb-8">Resultat Econòmic</h3>
                <div className="space-y-6">
                  <div>
                    <p className="text-[9px] font-bold text-slate-500 uppercase">Cost Materia Primera</p>
                    <p className="text-4xl font-black">{costTotalIngredients.toFixed(2)}€</p>
                  </div>
                  <div className="bg-white/5 p-5 rounded-2xl border border-white/5">
                    <div className="flex justify-between text-[10px] font-black uppercase mb-3">
                      <span>Marge Desitjat</span>
                      <span className="text-orange-500">{margenBenefici}%</span>
                    </div>
                    <input type="range" min="30" max="90" className="w-full accent-orange-500 h-1 rounded-lg" value={margenBenefici} onChange={e => setMargenBenefici(e.target.value)} />
                  </div>
                  <div className="pt-6 border-t border-white/10">
                    <p className="text-[9px] font-bold text-orange-500 uppercase">PVP Suggerit (S/I)</p>
                    <p className="text-5xl font-black text-white">{preuSugerit.toFixed(2)}€</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
